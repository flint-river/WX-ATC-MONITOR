<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSky Live Traffic Monitor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #30363d;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #58a6ff;
        }
        
        .subtitle {
            color: #8b949e;
            font-size: 14px;
        }
        
        .timestamp {
            color: #6e7681;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .airport-input {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .airport-input input {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            width: 120px;
            text-transform: uppercase;
        }
        
        .airport-input input::placeholder {
            color: #6e7681;
        }
        
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        button:hover {
            background: #2ea043;
        }
        
        button:disabled {
            background: #21262d;
            color: #6e7681;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        
        button.secondary:hover {
            background: #30363d;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-card .label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
        }
        
        .summary-card.ground .value { color: #f0883e; }
        .summary-card.airborne .value { color: #58a6ff; }
        .summary-card.approaching .value { color: #a371f7; }
        .summary-card.departing .value { color: #3fb950; }
        
        .queue-alert {
            background: #3d1a1a;
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .queue-alert.moderate {
            background: #3d2d1a;
            border-color: #d29922;
        }
        
        .queue-alert.light {
            background: #1a3d1a;
            border-color: #3fb950;
        }
        
        .queue-alert .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .queue-alert .time {
            font-size: 32px;
            font-weight: bold;
        }
        
        .queue-alert.moderate .time { color: #d29922; }
        .queue-alert.light .time { color: #3fb950; }
        
        .airport-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .airport-header {
            background: #21262d;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .airport-header:hover {
            background: #30363d;
        }
        
        .airport-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .airport-header .icao {
            background: #58a6ff;
            color: #0d1117;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .airport-header .stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }
        
        .airport-header .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .airport-content {
            padding: 20px;
        }
        
        .airline-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .airline-chip {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .airline-chip .count {
            background: #30363d;
            border-radius: 10px;
            padding: 2px 8px;
            font-weight: bold;
            color: #58a6ff;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }
        
        .tab {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .tab:hover {
            background: #21262d;
            color: #e6edf3;
        }
        
        .tab.active {
            background: #58a6ff;
            color: #0d1117;
            border-color: #58a6ff;
        }
        
        .aircraft-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .aircraft-table th {
            text-align: left;
            padding: 10px;
            background: #21262d;
            color: #8b949e;
            font-weight: 500;
            border-bottom: 1px solid #30363d;
        }
        
        .aircraft-table td {
            padding: 10px;
            border-bottom: 1px solid #21262d;
        }
        
        .aircraft-table tr:hover {
            background: #21262d;
        }
        
        .callsign {
            font-family: monospace;
            font-weight: bold;
            color: #58a6ff;
        }
        
        .altitude { color: #f0883e; }
        .speed { color: #8b949e; }
        .vs-climb { color: #3fb950; }
        .vs-descend { color: #f85149; }
        
        .congestion-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .congestion-low { background: #238636; }
        .congestion-moderate { background: #9e6a03; }
        .congestion-high { background: #bd561d; }
        .congestion-severe { background: #da3633; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .trend-increasing { background: #3d1a1a; color: #f85149; }
        .trend-decreasing { background: #1a3d1a; color: #3fb950; }
        .trend-stable { background: #21262d; color: #8b949e; }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }
        
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 40px 20px;
            background: #3d1a1a;
            border: 1px solid #f85149;
            border-radius: 8px;
            color: #f85149;
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #8b949e;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #30363d;
            color: #6e7681;
            font-size: 12px;
        }
        
        footer a {
            color: #58a6ff;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .preset-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .preset-btn:hover {
            background: #30363d;
            color: #e6edf3;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .auto-refresh select {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .airport-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .aircraft-table {
                font-size: 11px;
            }
            
            .aircraft-table th,
            .aircraft-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úàÔ∏è OpenSky Live Traffic Monitor</h1>
            <div class="subtitle">Real-time aircraft tracking for deicing airports</div>
            <div class="timestamp" id="timestamp">Enter airports to begin</div>
            <div id="fetchStatus" style="font-size: 11px; color: #888; margin-top: 5px;"></div>
        </header>
        
        <div class="controls">
            <div class="airport-input">
                <input type="text" id="airport1" placeholder="KORD" maxlength="4">
                <input type="text" id="airport2" placeholder="KJFK" maxlength="4">
                <input type="text" id="airport3" placeholder="KBOS" maxlength="4">
                <input type="text" id="airport4" placeholder="KDTW" maxlength="4">
            </div>
        </div>
        
        <div class="presets">
            <button class="preset-btn" onclick="setPreset('northeast')">Northeast</button>
            <button class="preset-btn" onclick="setPreset('midwest')">Midwest</button>
            <button class="preset-btn" onclick="setPreset('west')">West Coast</button>
            <button class="preset-btn" onclick="setPreset('hubs')">Major Hubs</button>
        </div>
        
        <div class="controls">
            <button id="fetchBtn" onclick="fetchAllAirports()">üîÑ Fetch Aircraft Data</button>
            <div class="auto-refresh">
                <span>Auto:</span>
                <select id="autoRefresh" onchange="setAutoRefresh()">
                    <option value="0">Off</option>
                    <option value="1">1 min</option>
                    <option value="2">2 min</option>
                    <option value="5" selected>5 min</option>
                </select>
            </div>
        </div>
        
        <div id="content">
            <div class="no-data">
                <p>Enter up to 4 airport ICAO codes above and click "Fetch Aircraft Data"</p>
                <p style="margin-top: 10px; font-size: 12px;">Examples: KORD, KJFK, KBOS, KMSP, KDEN, KSEA</p>
            </div>
        </div>
        
        <footer>
            Data from <a href="https://opensky-network.org" target="_blank">OpenSky Network</a> ‚Ä¢ 
            ~25nm radius around each airport ‚Ä¢ 
            Queue estimates are approximate
        </footer>
    </div>

    <script>
        // Airline ICAO codes to names
        const AIRLINE_CODES = {
            'AAL': 'American', 'DAL': 'Delta', 'UAL': 'United', 'SWA': 'Southwest',
            'JBU': 'JetBlue', 'ASA': 'Alaska', 'NKS': 'Spirit', 'FFT': 'Frontier',
            'SKW': 'SkyWest', 'RPA': 'Republic', 'ENY': 'Envoy', 'PDT': 'Piedmont',
            'ASH': 'Mesa', 'JIA': 'PSA', 'EJA': 'NetJets', 'FDX': 'FedEx',
            'UPS': 'UPS', 'GTI': 'Atlas', 'ABX': 'ABX Air', 'POE': 'Porter',
            'WJA': 'WestJet', 'ACA': 'Air Canada', 'AMX': 'AeroMexico',
            'VRD': 'Virgin', 'HAL': 'Hawaiian', 'AFR': 'Air France', 'BAW': 'British',
            'DLH': 'Lufthansa', 'KLM': 'KLM', 'UAE': 'Emirates', 'QTR': 'Qatar',
            'SIA': 'Singapore', 'CPA': 'Cathay', 'ANA': 'ANA', 'JAL': 'JAL',
            'KAL': 'Korean', 'THY': 'Turkish', 'ETH': 'Ethiopian', 'QFA': 'Qantas',
            'LXJ': 'Flexjet', 'EJM': 'ExecJet', 'N': 'Private/GA'
        };
        
        // Airport coordinates
        const AIRPORT_COORDS = {
            'KATL': { lat: 33.6407, lon: -84.4277, name: 'Atlanta' },
            'KLAX': { lat: 33.9425, lon: -118.4081, name: 'Los Angeles' },
            'KORD': { lat: 41.9742, lon: -87.9073, name: 'Chicago ORD' },
            'KDFW': { lat: 32.8998, lon: -97.0403, name: 'Dallas/Fort Worth' },
            'KDEN': { lat: 39.8561, lon: -104.6737, name: 'Denver' },
            'KJFK': { lat: 40.6413, lon: -73.7781, name: 'New York JFK' },
            'KSFO': { lat: 37.6213, lon: -122.3790, name: 'San Francisco' },
            'KLAS': { lat: 36.0840, lon: -115.1537, name: 'Las Vegas' },
            'KMCO': { lat: 28.4312, lon: -81.3081, name: 'Orlando' },
            'KSEA': { lat: 47.4502, lon: -122.3088, name: 'Seattle' },
            'KMIA': { lat: 25.7959, lon: -80.2870, name: 'Miami' },
            'KPHX': { lat: 33.4373, lon: -112.0078, name: 'Phoenix' },
            'KEWR': { lat: 40.6895, lon: -74.1745, name: 'Newark' },
            'KIAH': { lat: 29.9902, lon: -95.3368, name: 'Houston IAH' },
            'KBOS': { lat: 42.3656, lon: -71.0096, name: 'Boston' },
            'KMSP': { lat: 44.8848, lon: -93.2223, name: 'Minneapolis' },
            'KDTW': { lat: 42.2162, lon: -83.3554, name: 'Detroit' },
            'KFLL': { lat: 26.0742, lon: -80.1506, name: 'Fort Lauderdale' },
            'KPHL': { lat: 39.8744, lon: -75.2424, name: 'Philadelphia' },
            'KLGA': { lat: 40.7769, lon: -73.8740, name: 'New York LGA' },
            'KBWI': { lat: 39.1774, lon: -76.6684, name: 'Baltimore' },
            'KSLC': { lat: 40.7899, lon: -111.9791, name: 'Salt Lake City' },
            'KDCA': { lat: 38.8512, lon: -77.0402, name: 'Washington DCA' },
            'KCLE': { lat: 41.4117, lon: -81.8498, name: 'Cleveland' },
            'KPIT': { lat: 40.4915, lon: -80.2329, name: 'Pittsburgh' },
            'KCLT': { lat: 35.2140, lon: -80.9431, name: 'Charlotte' },
            'KPDX': { lat: 45.5898, lon: -122.5951, name: 'Portland' },
            'KMDW': { lat: 41.7868, lon: -87.7522, name: 'Chicago MDW' },
            'KSTL': { lat: 38.7487, lon: -90.3700, name: 'St. Louis' },
            'KBUF': { lat: 42.9405, lon: -78.7322, name: 'Buffalo' },
            'KSYR': { lat: 43.1112, lon: -76.1063, name: 'Syracuse' },
            'KALB': { lat: 42.7483, lon: -73.8017, name: 'Albany' },
            'KROC': { lat: 43.1189, lon: -77.6724, name: 'Rochester' },
            'KPWM': { lat: 43.6462, lon: -70.3093, name: 'Portland ME' },
            'KBTV': { lat: 44.4720, lon: -73.1533, name: 'Burlington' },
            'KMKE': { lat: 42.9472, lon: -87.8966, name: 'Milwaukee' },
            'KOMA': { lat: 41.3032, lon: -95.8941, name: 'Omaha' },
            'KDSM': { lat: 41.5340, lon: -93.6631, name: 'Des Moines' },
            'KFAR': { lat: 46.9207, lon: -96.8158, name: 'Fargo' },
            'KBIS': { lat: 46.7727, lon: -100.7468, name: 'Bismarck' },
            'KDLH': { lat: 46.8421, lon: -92.1936, name: 'Duluth' },
            'KGRR': { lat: 42.8808, lon: -85.5228, name: 'Grand Rapids' },
            'KDAY': { lat: 39.9024, lon: -84.2194, name: 'Dayton' },
            'KCMH': { lat: 39.9980, lon: -82.8919, name: 'Columbus' },
            'KIND': { lat: 39.7173, lon: -86.2944, name: 'Indianapolis' },
            'KCVG': { lat: 39.0488, lon: -84.6678, name: 'Cincinnati' }
        };
        
        const PRESETS = {
            northeast: ['KJFK', 'KBOS', 'KEWR', 'KPHL'],
            midwest: ['KORD', 'KDTW', 'KMSP', 'KCLE'],
            west: ['KSEA', 'KDEN', 'KSFO', 'KSLC'],
            hubs: ['KATL', 'KORD', 'KDFW', 'KDEN']
        };
        
        let airportData = {};
        let refreshInterval = null;
        let dataHistory = {};
        
        function setPreset(preset) {
            const airports = PRESETS[preset];
            if (airports) {
                for (let i = 0; i < 4; i++) {
                    document.getElementById(`airport${i + 1}`).value = airports[i] || '';
                }
            }
        }
        
        function parseAirline(callsign) {
            if (!callsign) return { code: null, name: 'Unknown', flight: callsign };
            callsign = callsign.trim().toUpperCase();
            
            if (callsign.startsWith('N') && /^N\d/.test(callsign)) {
                return { code: 'N', name: 'Private/GA', flight: callsign };
            }
            
            const code = callsign.substring(0, 3);
            if (AIRLINE_CODES[code]) {
                return { code: code, name: AIRLINE_CODES[code], flight: callsign };
            }
            
            return { code: null, name: 'Other', flight: callsign };
        }
        
        function estimateDeicingQueue(groundCount, deicingPads = 4) {
            if (groundCount === 0) return null;
            
            const avgDeiceTime = 10;
            const queueTime = Math.ceil((groundCount / deicingPads) * avgDeiceTime);
            
            return {
                minutes: queueTime,
                status: queueTime > 60 ? 'severe' : queueTime > 30 ? 'heavy' : queueTime > 15 ? 'moderate' : 'light',
                groundCount: groundCount
            };
        }
        
        // CORS proxies to bypass browser restrictions
        const CORS_PROXIES = [
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        ];
        
        async function fetchWithProxy(url, proxyIndex = 0) {
            if (proxyIndex >= CORS_PROXIES.length) {
                console.error('All CORS proxies failed for:', url);
                throw new Error('All proxies failed - OpenSky may be blocking requests');
            }
            
            const proxyUrl = CORS_PROXIES[proxyIndex](url);
            console.log(`Trying proxy ${proxyIndex + 1}/${CORS_PROXIES.length}:`, proxyUrl.substring(0, 60) + '...');
            
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 20000);
                
                const response = await fetch(proxyUrl, {
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timeout);
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('Rate limited by OpenSky');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                console.log(`Proxy ${proxyIndex + 1} returned ${text.length} bytes`);
                
                if (!text || text.length < 10) {
                    throw new Error('Empty response');
                }
                
                return JSON.parse(text);
                
            } catch (e) {
                console.log(`Proxy ${proxyIndex + 1} failed:`, e.message);
                return fetchWithProxy(url, proxyIndex + 1);
            }
        }
        
        async function fetchAirportData(icao) {
            const coords = AIRPORT_COORDS[icao];
            if (!coords) {
                return { error: `Unknown airport: ${icao}` };
            }
            
            const boxSize = 0.4;
            const lamin = coords.lat - boxSize;
            const lamax = coords.lat + boxSize;
            const lomin = coords.lon - boxSize;
            const lomax = coords.lon + boxSize;
            
            const url = `https://opensky-network.org/api/states/all?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
            
            try {
                const data = await fetchWithProxy(url);
                return processAircraftData(icao, data, coords);
                
            } catch (e) {
                if (e.name === 'AbortError') {
                    return { error: 'Request timed out' };
                }
                return { error: e.message };
            }
        }
        
        function processAircraftData(icao, data, coords) {
            const aircraft = {
                icao: icao,
                name: coords.name,
                total: 0,
                onGround: 0,
                airborne: 0,
                approaching: 0,
                departing: 0,
                airlines: {},
                groundAircraft: [],
                approachingAircraft: [],
                departingAircraft: [],
                allAircraft: []
            };
            
            if (!data || !data.states) {
                return aircraft;
            }
            
            aircraft.total = data.states.length;
            
            for (const state of data.states) {
                const callsign = (state[1] || '').trim();
                const onGround = state[8];
                const altitude = state[7];
                const verticalRate = state[11];
                const velocity = state[9];
                
                const airlineInfo = parseAirline(callsign);
                if (airlineInfo.name) {
                    aircraft.airlines[airlineInfo.name] = (aircraft.airlines[airlineInfo.name] || 0) + 1;
                }
                
                const acInfo = {
                    icao24: state[0],
                    callsign: callsign,
                    airline: airlineInfo.name,
                    lat: state[6],
                    lon: state[5],
                    altitude: altitude,
                    altitudeFt: altitude ? Math.round(altitude * 3.28084) : null,
                    onGround: onGround,
                    velocity: velocity,
                    velocityKts: velocity ? Math.round(velocity * 1.944) : null,
                    verticalRate: verticalRate,
                    verticalRateFpm: verticalRate ? Math.round(verticalRate * 196.85) : null
                };
                
                aircraft.allAircraft.push(acInfo);
                
                if (onGround) {
                    aircraft.onGround++;
                    aircraft.groundAircraft.push(acInfo);
                } else {
                    aircraft.airborne++;
                    
                    if (altitude !== null && altitude < 3000) {
                        if (verticalRate !== null && verticalRate < -2) {
                            aircraft.approaching++;
                            aircraft.approachingAircraft.push(acInfo);
                        } else if (verticalRate !== null && verticalRate > 2) {
                            aircraft.departing++;
                            aircraft.departingAircraft.push(acInfo);
                        }
                    }
                }
            }
            
            // Sort
            aircraft.approachingAircraft.sort((a, b) => (a.altitude || 99999) - (b.altitude || 99999));
            aircraft.airlinesSorted = Object.entries(aircraft.airlines).sort((a, b) => b[1] - a[1]);
            aircraft.deicingQueue = estimateDeicingQueue(aircraft.onGround);
            
            // Track history
            if (!dataHistory[icao]) dataHistory[icao] = [];
            dataHistory[icao].push({
                time: new Date(),
                onGround: aircraft.onGround,
                total: aircraft.total
            });
            if (dataHistory[icao].length > 12) dataHistory[icao].shift();
            
            // Calculate trend
            if (dataHistory[icao].length >= 2) {
                const prev = dataHistory[icao][0];
                const curr = dataHistory[icao][dataHistory[icao].length - 1];
                const diff = curr.onGround - prev.onGround;
                aircraft.trend = {
                    change: diff,
                    direction: diff > 2 ? 'increasing' : diff < -2 ? 'decreasing' : 'stable'
                };
            }
            
            return aircraft;
        }
        
        async function fetchAllAirports() {
            const btn = document.getElementById('fetchBtn');
            const content = document.getElementById('content');
            
            const airports = [];
            for (let i = 1; i <= 4; i++) {
                const val = document.getElementById(`airport${i}`).value.trim().toUpperCase();
                if (val && val.length === 4) {
                    airports.push(val);
                }
            }
            
            if (airports.length === 0) {
                content.innerHTML = '<div class="error">Please enter at least one airport ICAO code</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Fetching aircraft data for ${airports.join(', ')}...</div>
                </div>
            `;
            
            airportData = {};
            const statusEl = document.getElementById('fetchStatus');
            
            for (let i = 0; i < airports.length; i++) {
                const icao = airports[i];
                statusEl.textContent = `Fetching ${icao} (${i + 1}/${airports.length})... using CORS proxy`;
                airportData[icao] = await fetchAirportData(icao);
                if (airportData[icao].error) {
                    statusEl.innerHTML = `<span style="color:#e74c3c;">‚ö†Ô∏è ${icao}: ${airportData[icao].error}</span>`;
                }
                await new Promise(r => setTimeout(r, 300));
            }
            
            statusEl.textContent = '';
            
            renderResults();
            
            document.getElementById('timestamp').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Fetch Aircraft Data';
        }
        
        function renderResults() {
            const content = document.getElementById('content');
            const airports = Object.values(airportData);
            
            if (airports.length === 0) {
                content.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }
            
            // Calculate totals
            let totalAircraft = 0, totalGround = 0, totalAirborne = 0, totalApproaching = 0;
            for (const apt of airports) {
                if (!apt.error) {
                    totalAircraft += apt.total || 0;
                    totalGround += apt.onGround || 0;
                    totalAirborne += apt.airborne || 0;
                    totalApproaching += apt.approaching || 0;
                }
            }
            
            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="value">${totalAircraft}</div>
                        <div class="label">Total Aircraft</div>
                    </div>
                    <div class="summary-card ground">
                        <div class="value">${totalGround}</div>
                        <div class="label">On Ground</div>
                    </div>
                    <div class="summary-card airborne">
                        <div class="value">${totalAirborne}</div>
                        <div class="label">Airborne</div>
                    </div>
                    <div class="summary-card approaching">
                        <div class="value">${totalApproaching}</div>
                        <div class="label">Approaching</div>
                    </div>
                </div>
            `;
            
            for (const apt of airports) {
                if (apt.error) {
                    html += `
                        <div class="airport-section">
                            <div class="airport-header">
                                <h2><span class="icao">${apt.icao || '???'}</span> Error</h2>
                            </div>
                            <div class="airport-content">
                                <div class="error">${apt.error}</div>
                            </div>
                        </div>
                    `;
                    continue;
                }
                
                const sectionId = `section-${apt.icao}`;
                
                // Queue alert
                let queueHtml = '';
                if (apt.deicingQueue) {
                    const q = apt.deicingQueue;
                    const alertClass = q.status === 'severe' ? '' : q.status === 'heavy' ? '' : q.status === 'moderate' ? 'moderate' : 'light';
                    queueHtml = `
                        <div class="queue-alert ${alertClass}">
                            <div class="title">Estimated Deicing Queue</div>
                            <div class="time">${q.minutes} min</div>
                            <div>${q.groundCount} aircraft on ground</div>
                        </div>
                    `;
                }
                
                // Congestion badge
                let congestion = 'low';
                if (apt.onGround > 30) congestion = 'severe';
                else if (apt.onGround > 20) congestion = 'high';
                else if (apt.onGround > 10) congestion = 'moderate';
                
                // Trend
                let trendHtml = '';
                if (apt.trend) {
                    const icon = apt.trend.direction === 'increasing' ? 'üìà' : apt.trend.direction === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                    const changeText = apt.trend.change > 0 ? `+${apt.trend.change}` : `${apt.trend.change}`;
                    trendHtml = `<span class="trend-indicator trend-${apt.trend.direction}">${icon} ${changeText}</span>`;
                }
                
                // Airlines
                let airlinesHtml = '<div class="airline-breakdown">';
                for (const [airline, count] of (apt.airlinesSorted || []).slice(0, 8)) {
                    airlinesHtml += `<span class="airline-chip">${airline} <span class="count">${count}</span></span>`;
                }
                airlinesHtml += '</div>';
                
                html += `
                    <div class="airport-section" id="${sectionId}">
                        <div class="airport-header" onclick="toggleSection('${sectionId}')">
                            <h2>
                                <span class="icao">${apt.icao}</span> 
                                ${apt.name}
                                <span class="congestion-badge congestion-${congestion}">${congestion}</span>
                                ${trendHtml}
                            </h2>
                            <div class="stats">
                                <span class="stat"><span style="color:#f0883e;">${apt.onGround}</span> ground</span>
                                <span class="stat"><span style="color:#58a6ff;">${apt.airborne}</span> air</span>
                                <span class="stat"><span style="color:#a371f7;">${apt.approaching}</span> inbound</span>
                            </div>
                        </div>
                        <div class="airport-content" id="${sectionId}-content">
                            ${queueHtml}
                            <h4 style="margin-bottom: 10px; color: #8b949e;">Airlines</h4>
                            ${airlinesHtml}
                            
                            <div class="tabs" id="${sectionId}-tabs">
                                <button class="tab active" onclick="showTab('${sectionId}', 'ground')">Ground (${apt.groundAircraft?.length || 0})</button>
                                <button class="tab" onclick="showTab('${sectionId}', 'approaching')">Approaching (${apt.approachingAircraft?.length || 0})</button>
                                <button class="tab" onclick="showTab('${sectionId}', 'departing')">Departing (${apt.departingAircraft?.length || 0})</button>
                                <button class="tab" onclick="showTab('${sectionId}', 'all')">All (${apt.allAircraft?.length || 0})</button>
                            </div>
                            
                            <div id="${sectionId}-table">
                                ${renderAircraftTable(apt.groundAircraft || [])}
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <a href="https://flightaware.com/live/airport/${apt.icao}" target="_blank" style="color: #58a6ff; font-size: 12px;">View on FlightAware ‚Üí</a>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        function renderAircraftTable(aircraft) {
            if (!aircraft || aircraft.length === 0) {
                return '<div class="no-data">No aircraft in this category</div>';
            }
            
            let html = `
                <table class="aircraft-table">
                    <thead>
                        <tr>
                            <th>Callsign</th>
                            <th>Airline</th>
                            <th>Altitude</th>
                            <th>Speed</th>
                            <th>V/S</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const ac of aircraft) {
                const alt = ac.onGround ? 'GND' : (ac.altitudeFt ? `${Math.round(ac.altitudeFt/100)*100}ft` : '---');
                const spd = ac.velocityKts ? `${ac.velocityKts}kt` : '---';
                const vs = ac.verticalRateFpm ? `${ac.verticalRateFpm > 0 ? '+' : ''}${ac.verticalRateFpm}` : '---';
                const vsClass = ac.verticalRateFpm > 0 ? 'vs-climb' : ac.verticalRateFpm < 0 ? 'vs-descend' : '';
                
                html += `
                    <tr>
                        <td class="callsign">${ac.callsign || ac.icao24 || '---'}</td>
                        <td>${ac.airline || '---'}</td>
                        <td class="altitude">${alt}</td>
                        <td class="speed">${spd}</td>
                        <td class="${vsClass}">${vs}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            return html;
        }
        
        function showTab(sectionId, tab) {
            const apt = airportData[sectionId.replace('section-', '')];
            if (!apt) return;
            
            // Update tab styling
            const tabs = document.querySelectorAll(`#${sectionId}-tabs .tab`);
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get appropriate aircraft list
            let aircraft;
            switch (tab) {
                case 'ground': aircraft = apt.groundAircraft; break;
                case 'approaching': aircraft = apt.approachingAircraft; break;
                case 'departing': aircraft = apt.departingAircraft; break;
                case 'all': aircraft = apt.allAircraft; break;
                default: aircraft = [];
            }
            
            document.getElementById(`${sectionId}-table`).innerHTML = renderAircraftTable(aircraft || []);
        }
        
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            if (content) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function setAutoRefresh() {
            const mins = parseInt(document.getElementById('autoRefresh').value);
            if (refreshInterval) clearInterval(refreshInterval);
            if (mins > 0) {
                refreshInterval = setInterval(fetchAllAirports, mins * 60 * 1000);
            }
        }
        
        // Initialize with default preset
        setPreset('midwest');
    </script>
</body>
</html>
